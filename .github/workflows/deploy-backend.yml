name: Deploy Backend

on:
  push:
    branches: [main, master]
    paths:
      - 'api/**'
      - '.github/workflows/deploy-backend.yml'
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'api/**'
      - '.github/workflows/deploy-backend.yml'

jobs:
  deploy:
    permissions:
      contents: 'read'
      id-token: 'write'

    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # キーファイルを直接作成して使用する方法
      - name: Setup gcloud CLI
        run: |
          # サービスアカウントキーファイルを作成
          echo '${{ secrets.GCP_SA_KEY }}' > /tmp/service-account-key.json
          # gcloud CLIをインストール
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
          curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
          sudo apt-get update && sudo apt-get install google-cloud-cli
          # サービスアカウントで認証
          gcloud auth activate-service-account --key-file=/tmp/service-account-key.json
          gcloud config set project aa-dashboard-457316

      - name: Verify Authentication
        run: |
          gcloud auth list
          gcloud config list

      - name: Deploy to Cloud Run
        env:
          REGION: 'asia-northeast1'
          BACKEND_SERVICE_NAME: 'backend-api'
          PAYMASTER_ADDRESS: '0x415b4ceC5cf512CeDBE09C12081A0b75E13854Ff'
        run: |
          NON_SECRET_ENV_VARS="NODE_ENV=production,PAYMASTER_ADDRESS=${PAYMASTER_ADDRESS}"
          SECRET_VARS="ALCHEMY_API_KEY=ALCHEMY_API_KEY:latest,PAYMASTER_PRIVATE_KEY=PAYMASTER_PRIVATE_KEY:latest"

          echo "Deploying to Cloud Run: ${BACKEND_SERVICE_NAME}"
          gcloud run deploy ${BACKEND_SERVICE_NAME} \
            --project=aa-dashboard-457316 \
            --source ./api \
            --region ${REGION} \
            --platform managed \
            --allow-unauthenticated \
            --port 4000 \
            --update-env-vars "${NON_SECRET_ENV_VARS}" \
            --update-secrets="${SECRET_VARS}"

      # 後片付け
      - name: Cleanup
        if: always()
        run: rm -f /tmp/service-account-key.json
